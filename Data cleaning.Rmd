---
title: "Loading WoS data"
author: "Kristine"
date: "27/4/2021"
output: html_document
---

HEY KRIS. Du kan finde genderize i sidste chunk. Jeg er ikke 100 på at de virker endnu

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
pacman::p_load(tidyverse,
               dplyr,
               plyr,
               stringr,
               readxl,
               purrr,
               genderizeR)

```

Loading all data
```{r}
#listing files
data.list <- list.files(pattern = '*.xls')

#read files 
dat = lapply(data.list, function(i){
    x = read_excel(i)
    
    x
})

#making dataframe 
df <- ldply (dat, data.frame)

#save csv
write_csv(df, "alldata.csv") 
```


cleaning data
We need to find:
- first authors first name (Author.Full.Names)
- last authors first name
- papers where first author is for Asrhus university
```{r}
#read csv with all files
#df <- read.csv("alldata.csv")


##extracting author names - only keep first names fra first Author and last author

#Making empty columns to fill
dfnames <- df %>% 
    mutate(
      First.Author.Name = Author.Full.Names,
      Last.Author.Name = Author.Full.Names)

#extracting first and last author names - full names 
dfnames <- dfnames %>%
  mutate(
    First.Author.Name = gsub(";.*", '', First.Author.Name),
    Last.Author.Name = gsub(".*;", '', Last.Author.Name)
  )

#finding first name only
# - first name is after comma
dfnames <- dfnames %>%
  mutate(
    First.Author.Name = gsub(".*,", '', First.Author.Name),
    Last.Author.Name = gsub(".*,", '', Last.Author.Name)
  )

#removing space in front of first character
dfnames <- dfnames %>%
  mutate(
    First.Author.Name = str_replace(First.Author.Name, " ", ""),
    Last.Author.Name = str_replace(Last.Author.Name, " ", "")
  )

# - only keep one name (first name before space)
dfnames <- dfnames %>%
  mutate(
    First.Author.Name = gsub(" .*", '', First.Author.Name),
    Last.Author.Name = gsub(" .*", '', Last.Author.Name)
  )

#Now its time for genderize!
#but first let's only look at papers with first author from Aarhus univerity

```

Finding papers with first author from Aarhus university
```{r}
#extract characters after ]
aarhuspapers <- dfnames %>%
  mutate(
    First.Author.University = gsub(".*]", '', Addresses)
  )

#remove space infront of characters   
aarhuspapers <- aarhuspapers %>%
  mutate(
    First.Author.University = str_replace(First.Author.University, " ", "")
  ) 

#Extract characters before comma
aarhuspapers <- aarhuspapers %>%
  mutate(
    First.Author.University = gsub(",.*", '', First.Author.University)
  )

#we have a total of 29154 observations from all universities

#Now we only find papers from Aarhus university

#aarhuspapersfactor <- aarhuspapers %>%
#  mutate(
#    First.Author.University = as.factor(First.Author.University)
#  )
#aarhuspapersfactor$First.Author.University

#factor = 5098 universities

#filtering only Aarhus univeristy
aarhuspapers <- aarhuspapers %>%
  dplyr::filter(First.Author.University == "Aarhus Univ")

#9318 observations = papers form Aarhus uni 
#note some papers might have used another wording for aarhus university e.g University Aarhus - these are not included as I only eyeballed 3 or something
# Could also consider if we should include papers from Aarhus universit hospital
```


Variables to keep:
- Article title
- First author name
- Last author name
- Abstract
- Citations (find den rigtige)
- publication year
- Research area (tror det er det tætteste we kommer på fakultet)

```{r}
#selecting only interesting variables
newdf <- aarhuspapers %>%
  subset(
    select = c("Article.Title",
               "Abstract",
               "Cited.Reference.Count",
               "Times.Cited..WoS.Core",
               "Times.Cited..All.Databases",
               "Since.2013.Usage.Count",
               "Publisher",
               "Publication.Year",
               "WoS.Categories",
               "Author.First.Name",
               "Author.Last.Name",
               "First.Author.University")
  )

write.csv(newdf, "cleandata.csv")

```

Define gender of first author and second author
- using genderizeR
- adding two new columns

```{r}

#Predicting first author gender 
First.Author.Gender <- findGivenNames(newdf$Author.First.Name, textPrepare = FALSE, country = NULL, language = NULL, apikey = "eabaf20628864c8dff0f446d606570a9", queryLength = 10,progress = FALSE, ssl.verifypeer = FALSE)

#Predicting last author gender
Last.Authour.Gender <- findGivenNames(newdf$Author.Last.Name, textPrepare = FALSE, country = NULL, language = NULL, apikey = "eabaf20628864c8dff0f446d606570a9", queryLength = 10, progress = FALSE, ssl.verifypeer = FALSE)


#firstname_gender <- First.Author.Gender #%>% 
#  mutate(
#    name = as.character(name),
#    gender = as.character(gender),
#    probability = #as.numeric(probability),
#    count = as.numeric(count),
#    country_id = as.character(country_id)
#  )

#renaming variables first author
First.Author.Gender <- First.Author.Gender %>% 
  dplyr::rename(
    Author.First.Name= name,
    Author.First.Gender = gender,
    Author.First.Gender.Probability = probability,
    Author.First.Gender.Count = count,
    Author.First.Gender.Country_ID = country_id
  )

#renaming variables last author
Lastname_gender <- Lastname_gender %>% 
  dplyr::rename(
    Author.Last.Name = name,
    Author.Last.Gender = gender,
    Author.Last.Gender.Probability = probability,
    Author.Last.Gender.Count = count,
    Author.Last.Gender.Country_ID = country_id
  )


#merging df with gender dataframe by Author.First.Name
firstnew <- merge(newdf,firstname_gender, by = "Author.First.Name")

#Removing dublicates
firstnew <- firstnew %>% distinct(X,.keep_all = TRUE)


#Removing duplicates 
newdf$Article.Title[duplicated(newdf$Article.Title)]

#Merging df with last Author gender
semifinaldf <- merge(firstnew,Lastname_gender, by = "Author.Last.Name")

#Removing dublicates
semifinaldf <- semifinaldf %>% distinct(X,.keep_all = TRUE)


#save csv 
write.csv("semifinaldf.csv")
```

Save csv for BERT in Python

