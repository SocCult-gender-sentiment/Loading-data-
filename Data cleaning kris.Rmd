---
title: "Loading WoS data"
author: "Kristine"
date: "27/4/2021"
output: html_document
---

HEY KRIS. Du kan finde genderize i sidste chunk. Jeg er ikke 100 på at de virker endnu

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
pacman::p_load(tidyverse,
               dplyr,
               plyr,
               stringr,
               readxl,
               purrr)

library("dplyr")

```

Loading all data
```{r}
data.list <- list.files(pattern = '*.xls')

dat = lapply(data.list, function(i){
    x = read_excel(i)
    # Get the columns you want, e.g. 1, 3, 5
    # x = x[, c(1, 3, 5)]
    # You may want to add a column to say which file they're from
    # x$file = i
    # Return your data
    x
})

 df <- ldply (dat, data.frame)

write_csv(df, "alldata.csv") 

df<- read_csv("alldata.csv")
```


cleaning data
We need to find:
- first authors first name (Author.Full.Names)
- last authors first name
- papers where first author is for Asrhus university
```{r}
##extracting author names - only keep first name
#Making columns for both
dfnames <- df %>% 
    mutate(
      Author.First.Name = Author.Full.Names,
      Author.Last.Name = Author.Full.Names)

#extracting first and last author names - full names 
dfnames1 <- dfnames %>%
  mutate(
    Author.First.Name = gsub(";.*", '', Author.First.Name),
    Author.Last.Name = gsub(".*;", '', Author.Last.Name)
  )
#finding first name only
# - first name is after comma
dfnames1 <- dfnames1 %>%
  mutate(
    Author.First.Name = gsub(".*,", '', Author.First.Name),
    Author.Last.Name = gsub(".*,", '', Author.Last.Name)
  )
#removing space in front of first character
dfnames1 <- dfnames1 %>%
  mutate(
    Author.First.Name = str_replace(Author.First.Name, " ", ""),
    Author.Last.Name = str_replace(Author.Last.Name, " ", "")
  )

# - only keep one name (first name before space)
dfnames1 <- dfnames1 %>%
  mutate(
    Author.First.Name = gsub(" .*", '', Author.First.Name),
    Author.Last.Name = gsub(" .*", '', Author.Last.Name)
  )

#Now its time for genderize!


#dfnames1 <- dfnames %>%
#  mutate(
#    Author.First.Name = str_extract(Author.First.Name, #pattern="[\\w]"),
#    Author.Last.Name = str_extract(Author.Last.Name, #pattern="[\\w]")
#  )



#Det her virker men er ikke optimalt da nogle forfattere har flere fornavne
#dfnames <- dfnames %>%
#  mutate(
#    Author.First.Name = word(Author.First.Name, 2),
#    Author.Last.Name = word(Author.Last.Name, -2)
#  )

#dfnames <- dfnames %>%
#  mutate(
#    Author.First.Name = separate(Author.First.Name, #c("Author.First.Name", NA), sep="[;]"),
#    Author.First.Name = separate(Author.First.Name, c(NA, #"Author.First.Name"), sep="[;]")
#  )

#str_locate_all(dfnames$Author.First.Name, ';')

#dfnames <- dfnames %>%
#  separate(Author.First.Name, c("Author.First.Name"), #sep="[;]")

#dfnames <- dfnames %>% separate(Author.First.Name, #c(NA,"Author.First.Name", sep=" ")
```

Finding papers with first author from Aarhus university
```{r}
aarhuspapers <- dfnames1 %>%
  mutate(
    First.Author.University = gsub(".*]", '', Addresses)
  )
   
aarhuspapers <- aarhuspapers %>%
  mutate(
    First.Author.University = str_replace(First.Author.University, " ", "")
  ) 

aarhuspapers <- aarhuspapers %>%
  mutate(
    First.Author.University = gsub(",.*", '', First.Author.University)
  )

#29154 observations
#only papers from Aarhus university
#aarhuspapersfactor <- aarhuspapers %>%
#  mutate(
#    First.Author.University = as.factor(First.Author.University)
#  )
#aarhuspapersfactor$First.Author.University

#factor = 5098 universities

aarhuspapers <- aarhuspapers %>%
  dplyr::filter(First.Author.University == "Aarhus Univ")

#9318 observations = papers form Aarhus uni 
#note some papers might have used another wording for aarhus university e.g University Aarhus - these are not included as I only eyeballed 3 or something
# Could also consider if we should include papers from Aarhus universit hospital
```


Variables to keep:
- Article title
- First author name
- Last author name
- Abstract
- Citations (find den rigtige)
- publication year
- Research area (tror det er det tætteste we kommer på fakultet)

```{r}
newdf <- aarhuspapers %>%
  subset(
    select = c("Article.Title",
               "Abstract",
               "Cited.Reference.Count",
               "Times.Cited..WoS.Core",
               "Times.Cited..All.Databases",
               "Since.2013.Usage.Count",
               "Publisher",
               "Publication.Year",
               "WoS.Categories",
               "Author.First.Name",
               "Author.Last.Name",
               "First.Author.University")
  )

write.csv(newdf, "cleandata.csv")

newdf<-read.csv("cleandata.csv")

```

KRISSSS 

Define gender of first author and second author
- using genderizeR
- adding two new collumns
```{r}


#firstnamegender

pacman::p_load("genderizeR")
install.packages("devtools")
install.packages(c("httr", "jsonlite"))
devtools::install_github("hadley/devtools")

devtools::install_github("kalimu/genderizeR")
library("genderizeR", "tidyverse", "httr", "jsonlite")
library("httr")
library("jsonlite")


#yet another try 
#Nanna <- findGivenNames(newdf$Author.First.Name, textPrepare = FALSE, country = NULL, language = NULL, apikey = "eabaf20628864c8dff0f446d606570a9", queryLength = 10,progress = FALSE, ssl.verifypeer = FALSE)


#Lastname_gender <- findGivenNames(newdf$Author.Last.Name, textPrepare = FALSE, country = NULL, language = NULL, apikey = "eabaf20628864c8dff0f446d606570a9", queryLength = 10, progress = FALSE, ssl.verifypeer = FALSE)





firstname_gender <- Nanna %>% 
  mutate(
    name = as.character(name),
    gender = as.character(gender),
    probability = as.numeric(probability),
    count = as.numeric(count),
    country_id = as.character(country_id)
  )

names(firstname_gender)[names(firstname_gender) == "name"] <- "Author.Last.Name"
names(firstname_gender)[names(firstname_gender) == "gender"] <- "Author.Last.Gender"
names(firstname_gender)[names(firstname_gender) == "probability"] <- "Author.Last.Gender.Probability"
names(firstname_gender)[names(firstname_gender) == "count"] <- "Author.Last.Gender.Count"
names(firstname_gender)[names(firstname_gender) == "country_id"] <- "Author.Last.Gender.Country_ID"

firstname_gender <- firstname_gender %>% 
  dplyr::rename(
    Author.First.Name= name,
    Author.First.Gender = gender,
    Author.First.Gender.Probability = probability,
    Author.First.Gender.Count = count,
    Author.First.Gender.Country_ID = country_id
  )

Lastname_gender <- Lastname_gender %>% 
  select(
    Author.Last.Name,
    Author.Last.Gender,
    Author.Last.Gender.Probability,
    Author.Last.Gender.Count,
    Author.Last.Gender.Country_ID
  )

Lastname_gender <- Lastname_gender %>% 
  mutate(
    name = as.character(name),
    gender = as.character(gender),
    probability = as.numeric(probability),
    count = as.numeric(count),
    country_id = as.character(country_id)
  )



Lastname_gender <- Lastname_gender %>% 
  dplyr::rename(
    Author.Last.Name = name,
    Author.Last.Gender = gender,
    Author.Last.Gender.Probability = probability,
    Author.Last.Gender.Count = count,
    Author.Last.Gender.Country_ID = country_id
  )



#merge the two dataframes by Author.First.Name
firstnew <- merge(newdf,firstname_gender, by = "Author.First.Name")

#removing duplicates from the merge dataframe containing first author and newdf 
singel <- firstnew %>% distinct(X,.keep_all = TRUE)
#Removing duplicates 
newdf$Article.Title[duplicated(newdf$Article.Title)]

semifinaldf <- merge(singel,Lastname_gender, by = "Author.Last.Name")

#Do the same for Author.Last.Name


#merge the two dataframes by Author.Last.Name
```

Save csv for BERT in Python

```{r}



```

