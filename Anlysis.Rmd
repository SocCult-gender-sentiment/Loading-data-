---
title: "Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
pacman::p_load(readr, 
               tidyverse,
               metafor,
               brms, 
               rethinking, 
               viridis, 
               bayesplot,
               psych)

```


loading and cleaning data
```{r}
df <- read.csv("df_lix_sentiment_confidence.csv")

df <- df %>%
  mutate(
    Title = as.factor(Article.Title),
    Last.Gender = as.factor(Last.Author.Gender),
    First.Gender = as.factor(First.Author.Gender),
    Sentiment = as.factor(label),
    Faculty = as.factor(Faculty),
    Citations = as.numeric(Times.Cited..All.Databases),
    Year = as.numeric(Publication.Year),
    Confidence = as.numeric(totalconfidence)
    
  )


df <- df %>%
  select(
    Title,
    Last.Gender,
    First.Gender,
    Sentiment,
    Faculty,
    Citations,
    Year,
    Confidence
  )


```



Removing NA's from Gender - do not run
```{r}
df <- df %>%
  drop_na(First.Gender)

df <- df %>%
  drop_na(Last.Gender)

```


Looking at distributions 

```{r}
#Citations
range(df$Citations)

hist(df$Citations, breaks = 1000, xlim = range(0:100))


```
Citations are count data - this calls for a poisson 


Confidence
```{r}
hist(df$Confidence, breaks = 100, xlim = range(-50:50))


```
Scaling confidence to be 0-centered
```{r}
df <- df %>% 
  mutate(
    Confidence = scale(Confidence)
  )

hist(df$Confidence, breaks = 100, xlim = range(-10:10))

```


#Building models 

Outcome: Citations

Predictors:
- First.gender
- Last.gender
- Sentiment
- Confidence
- Year
- Faculty



#With year and four way interaction for portfolio


```{r}
set.seed(1234)

f5 <- bf(Citations ~ 0 + Year +  Confidence : Sentiment : First.Gender : Last.Gender + (0 + Confidence : Sentiment : First.Gender : Last.Gender | Faculty))


get_prior(f5, data = df, family = negbinomial())


f5_prior <- c(
  prior(normal(0, 0.2), class = b, 
        coef = Year),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.1), class = sd))



m5_prior <- brm(
  f5,
  data = df,
  family = negbinomial(),
  prior = f5_prior,
  sample_prior = 'only',
  backend = "cmdstanr",
  chains = 2,
  cores = 2,
  file = "m5_prior"
)



df$preds <- predict(m5_prior,summary = T) [1,]

ggplot(df, aes(preds)) + geom_density()

pp_check(m5_prior, nsamples = 100)



```

```{r}
m5_post <- brm(
  f5,
  data = df,
  family = negbinomial(),
  prior = f5_prior,
  sample_prior = T,
  backend = "cmdstanr",
  chains = 2,
  cores = 2
)

pp_check(m5_post, nsamples = 100)

summary(m5_post)

stanplot(m5_post)

mcmc_plot(m5_post, pars = "^b_")

plot(m5_post)

#
pacman:: p_load(MASS)

mean(rnegbin(1.e4, mu = exp(0.19), theta = 0.57))

#Hypothesis testing
hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0")

#Posterior update check
plot(hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0"))

```

#Doing seperate models for sentiment and confidence

```{r}
set.seed(1234)

f1 <- bf(Citations ~ 0 + Year + Sentiment : First.Gender : Last.Gender + (0 + Sentiment : First.Gender : Last.Gender | Faculty))


get_prior(f1, data = df, family = negbinomial())


f1_prior <- c(
  prior(normal(0, 0.2), class = b, 
        coef = Year),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentNEGATIVE:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentNEGATIVE:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentNEGATIVE:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentPOSITIVE:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentPOSITIVE:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = SentimentPOSITIVE:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.1), class = sd))



m1_prior <- brm(
  f1,
  data = df,
  family = negbinomial(),
  prior = f1_prior,
  sample_prior = 'only',
  backend = "cmdstanr",
  chains = 2,
  cores = 2,
  file = "m5_prior"
)


#Prior predictive check - do not run - produces NAs
#pp_check(m1_prior, nsamples = 100)



```

```{r}
m1_post <- brm(
  f1,
  data = df,
  family = negbinomial(),
  prior = f1_prior,
  sample_prior = T,
  backend = "cmdstanr",
  chains = 2,
  cores = 2
)

pp_check(m1_post, nsamples = 100)

summary(m1_post)

stanplot(m1_post)

mcmc_plot(m1_post, pars = "^b_")

plot(m1_post)

#
pacman:: p_load(MASS)

mean(rnegbin(1.e4, mu = exp(0.19), theta = 0.57))

#Hypothesis testing
hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0")

#Posterior update check
plot(hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0"))

```


```{r}
set.seed(1234)

f2 <- bf(Citations ~ 0 + Year +  Confidence : First.Gender : Last.Gender + (0 + Confidence : First.Gender : Last.Gender | Faculty))


get_prior(f2, data = df, family = negbinomial())


f2_prior <- c(
  prior(normal(0, 0.2), class = b, 
        coef = Year),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:First.Genderfemale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef =  Confidence:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.1), class = sd))



m2_prior <- brm(
  f2,
  data = df,
  family = negbinomial(),
  prior = f2_prior,
  sample_prior = 'only',
  backend = "cmdstanr",
  chains = 2,
  cores = 2,
  file = "m5_prior"
)



pp_check(m2_prior, nsamples = 100)



```

```{r}
m2_post <- brm(
  f2,
  data = df,
  family = negbinomial(),
  prior = f2_prior,
  sample_prior = T,
  backend = "cmdstanr",
  chains = 2,
  cores = 2
)

pp_check(m2_post, nsamples = 100)

summary(m2_post)

stanplot(m2_post)

mcmc_plot(m2_post, pars = "^b_")

plot(m2_post)

#
pacman:: p_load(MASS)

mean(rnegbin(1.e4, mu = exp(0.19), theta = 0.57))

#Hypothesis testing
hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0")

#Posterior update check
plot(hypothesis(m5_post, "Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale - Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale > 0"))

```



