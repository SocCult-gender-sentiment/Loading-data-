---
title: "Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
pacman::p_load(readr, 
               tidyverse,
               metafor,
               brms, 
               rethinking, 
               viridis, 
               bayesplot,
               psych)

```


loading and cleaning data
```{r}
df <- read.csv("df_lix_sentiment_confidence.csv")

df <- df %>%
  mutate(
    Title = as.factor(Article.Title),
    Last.Gender = as.factor(Last.Author.Gender),
    First.Gender = as.factor(First.Author.Gender),
    Sentiment = as.factor(label),
    Faculty = as.factor(Faculty),
    Citations = as.numeric(Times.Cited..All.Databases),
    Year = as.numeric(Publication.Year),
    Confidence = as.numeric(totalconfidence)
    
  )


df <- df %>%
  select(
    Title,
    Last.Gender,
    First.Gender,
    Sentiment,
    Faculty,
    Citations,
    Year,
    Confidence
  )


```



Removing NA's from Gender - do not run
```{r}
df <- df %>%
  drop_na(First.Gender)

df <- df %>%
  drop_na(Last.Gender)

```


Looking at distributions 

```{r}
#Citations
range(df$Citations)

hist(df$Citations, breaks = 1000, xlim = range(0:100))


```
Citations are count data - this calls for a poisson 


Confidence
```{r}
hist(df$Confidence, breaks = 100, xlim = range(-50:50))


```
Scaling confidence to be 0-centered
```{r}
df <- df %>% 
  mutate(
    Confidence = scale(Confidence)
  )

hist(df$Confidence, breaks = 100, xlim = range(-10:10))

```


#Building models 

Outcome: Citations

Predictors:
- First.gender
- Last.gender
- Sentiment
- Confidence
- Year
- Faculty


```{r}
set.seed(1234)

f4 <- bf(Citations ~ 0 +  Confidence : Sentiment : First.Gender : Last.Gender + (0 + Confidence : Sentiment : First.Gender : Last.Gender | Faculty))


get_prior(f4, data = df, family = negbinomial())


f4_prior <- c(
  prior(lkj(2), class = cor),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.1), class = sd),
  prior(gamma(0.01, 0.01), class = shape))



m4_prior <- brm(
  f4,
  data = df,
  family = negbinomial(),
  prior = f4_prior,
  sample_prior = 'only',
  backend = "cmdstanr",
  chains = 2,
  cores = 2
)



pp_check(m4_prior, nsamples = 100)



```

```{r}
set.seed(1234)
m4_post <- brm(
  f4,
  data = df,
  family = negbinomial(),
  prior = f4_prior,
  sample_prior = T,
  backend = "cmdstanr",
  chains = 2,
  cores = 2
)

pp_check(m4_post, nsamples = 100)

summary(m4_post)

stanplot(m4_post)

plot(m4_post)

mean(rnbinom(1.e4, exp(0.08), prob = 0.5))

```

```{r}

mcmc_trace(m4_post,  pars = "b_Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale", "b_Confidence:SentimentNEGATIVE:First.Gendermale:Last.Genderfemale") + theme_classic()

mcmc_rank_overlay(m4_post, pars = "b_Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale", "b_Confidence:SentimentNEGATIVE:First.Gendermale:Last.Genderfemale") + theme_classic()



#Plot of estimates
mcmc_plot(m4_post)
#Hypothesis testing
hypothesis(m4_post, "Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale < Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale")
#Posterior update check
plot(hypothesis(m4_post, "Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale > Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale"))

mcmc_trace(m4_post)

#no valid effect detected from plots below
plot(conditional_effects(m4_post), point=T)

conditional_effects(m4_post)

```


#With year


```{r}
set.seed(1234)

f5 <- bf(Citations ~ 0 + Year +  Confidence : Sentiment : First.Gender : Last.Gender + (0 + Confidence : Sentiment : First.Gender : Last.Gender | Faculty))


get_prior(f5, data = df, family = negbinomial())


f5_prior <- c(
  prior(normal(0, 0.2), class = b, 
        coef = Year),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Genderfemale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Genderfemale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentNEGATIVE:First.Gendermale:Last.Gendermale ),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Genderfemale:Last.Gendermale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Genderfemale),
  prior(normal(0, 0.2), class = b, 
        coef = Confidence:SentimentPOSITIVE:First.Gendermale:Last.Gendermale),
  prior(normal(0, 0.1), class = sd))



m5_prior <- brm(
  f5,
  data = df,
  family = negbinomial(),
  prior = f5_prior,
  sample_prior = 'only',
  backend = "cmdstanr",
  chains = 2,
  cores = 2,
  file = "m5_prior"
)



df$preds <- predict(m5_prior,summary = T) [1,]

ggplot(df, aes(preds)) + geom_density()

 pp_check(m4_prior, nsamples = 100)



```

```{r}
m4_post <- brm(
  f4,
  data = df,
  family = negbinomial(),
  prior = f4_prior,
  sample_prior = T,
  backend = "cmdstanr",
  chains = 2,
  cores = 2,
  file ="m4_post",
  file_refit = "on_change"
)

pp_check(m4_post, nsamples = 100)

summary(m4_post)

stanplot(m4_post)

plot(m4_post)

mean(rnbinom(1.e4, exp(-0.06), prob = 0.1))

```




